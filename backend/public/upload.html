<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡Œç›®ç®¡ç†ä¸­å¿ƒ | Question Management</title>
    <style>
        :root {
            --bg-dark-primary: #0F172A;
            --bg-dark-secondary: #1E293B;
            --text-light-primary: #E2E8F0;
            --text-light-secondary: #94A3B8;
            --border-dark: #334155;
            --accent-blue: #3B82F6;
            --accent-green: #22C55E;
            --accent-red: #EF4444;
            --accent-yellow: #EAB308;
            --accent-grey: #64748B;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-dark-primary);
            color: var(--text-light-primary);
        }

        .container {
            background: var(--bg-dark-secondary);
            padding: 30px;
            border-radius: 10px;
            box-shadow: none;
            border: 1px solid var(--border-dark);
        }

        h1 {
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 50%, #EC4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
            letter-spacing: -0.5px;
            position: relative;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, #3B82F6, #8B5CF6, #EC4899);
            border-radius: 2px;
        }
        
        h2 {
            color: var(--text-light-primary);
            border-bottom: 1px solid var(--border-dark);
            padding-bottom: 10px;
            margin-top: 40px;
        }

        .form-group { margin-bottom: 20px; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light-secondary);
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            background-color: var(--bg-dark-primary);
            border: 1px solid var(--border-dark);
            color: var(--text-light-primary);
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-light-secondary);
            opacity: 0.7;
        }

        textarea { height: 100px; resize: vertical; }

        button {
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-right: 10px;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        button:hover { transform: translateY(-1px); }

        .primary { background-color: var(--accent-blue); }
        .primary:hover { background-color: #2563EB; }
        
        .secondary { background-color: var(--accent-grey); }
        .secondary:hover { background-color: #475569; }
        
        .danger { background-color: var(--accent-red); }
        .danger:hover { background-color: #DC2626; }
        
        .info { 
            background-color: var(--accent-yellow);
            color: var(--bg-dark-primary);
        }
        .info:hover { background-color: #D97706; }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 20px 0;
            opacity: 0;
            transition: opacity 0.5s ease-out;
            visibility: hidden;
            border: 1px solid transparent;
        }
        .status.show { opacity: 1; visibility: visible; }

        .success { 
            background-color: rgba(34, 197, 94, 0.1); 
            color: var(--accent-green);
            border-color: var(--accent-green);
        }
        .error { 
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            border-color: var(--accent-red);
        }

        .question-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-dark);
            padding: 10px;
            margin-top: 20px;
            background-color: var(--bg-dark-primary);
            border-radius: 6px;
        }
        
        .question-list::-webkit-scrollbar { width: 8px; }
        .question-list::-webkit-scrollbar-track {
            background: var(--bg-dark-secondary);
            border-radius: 4px;
        }
        .question-list::-webkit-scrollbar-thumb {
            background: var(--accent-grey);
            border-radius: 4px;
        }
        .question-list::-webkit-scrollbar-thumb:hover { background: #475569; }

        .question-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .question-item:last-child { border-bottom: none; }

        .question-content { flex-grow: 1; word-break: break-word; }
        .question-content strong { 
            font-size: 1.1em;
            color: var(--text-light-primary);
        }
        .question-content small {
            display: block;
            color: var(--text-light-secondary);
            margin-top: 8px;
            line-height: 1.5;
        }

        .action-buttons { flex-shrink: 0; margin-left: 15px; }
        .action-buttons button { padding: 6px 12px; font-size: 14px; margin-left: 5px; }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        .option-input { display: flex; align-items: center; gap: 10px; }
        .option-input input[type="text"] { flex: 1; }

        .debug-info {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š é¡Œç›®ç®¡ç†ä¸­å¿ƒ</h1>
        <p style="text-align: center; color: var(--text-light-secondary); margin-top: 30px; margin-bottom: 30px; font-size: 1.1em;">
            Question Management System
        </p>
        
        <div id="debugInfo" class="debug-info" style="display: none;">
            <strong>é™¤éŒ¯è³‡è¨Šï¼š</strong><br>
            <span id="debugText"></span>
        </div>

        <div id="status" class="status"></div>

        <form id="questionForm">
            <div class="form-group">
                <label for="questionText">é¡Œç›®å…§å®¹ *</label>
                <textarea id="questionText" placeholder="è«‹è¼¸å…¥é¡Œç›®..." required></textarea>
            </div>

            <div class="form-group">
                <label for="correctAnswer">æ­£ç¢ºç­”æ¡ˆç´¢å¼• *</label>
                <input type="number" id="correctAnswer" min="0" step="1" 
                       placeholder="è¼¸å…¥æ­£ç¢ºç­”æ¡ˆçš„ç´¢å¼• (0 = é¸é …1, 1 = é¸é …2...)" required>
            </div>

            <div class="form-group">
                <label for="correctAnswerText">æ­£ç¢ºç­”æ¡ˆæ–‡å­— *</label>
                <input type="text" id="correctAnswerText" placeholder="è«‹è¼¸å…¥æ­£ç¢ºç­”æ¡ˆçš„ä¸­æ–‡ï¼Œä¾‹å¦‚ï¼šé¸é …2 = 'è·¨ç«™è…³æœ¬æ”»æ“Š'" required>
            </div>

            <div class="form-group">
                <label for="description">é¡Œç›®è§£é‡‹ *</label>
                <textarea id="description" placeholder="è«‹è¼¸å…¥é¡Œç›®çš„è©³ç´°æè¿°æˆ–è§£é‡‹..." required></textarea>
            </div>

            <div class="form-group">
                <label>é¸é … *</label>
                <div class="options-container" id="optionsContainer"></div>
                <button type="button" id="addOptionBtn" class="info">æ–°å¢é¸é …</button>
            </div>

            <div class="form-group">
                <label for="category">åˆ†é¡</label>
                <input type="text" id="category" placeholder="ä¾‹å¦‚: javascript, html, css...">
            </div>

            <button type="submit" class="primary">æ–°å¢/æ›´æ–°é¡Œç›®</button>
            <button type="button" id="clearFormBtn" class="secondary">æ¸…ç©ºè¡¨å–®</button>
            <button type="button" id="clearAllBtn" class="danger">æ¸…ç©ºæ‰€æœ‰é¡Œç›®</button>
        </form>

        <h2>ğŸ“‹ å·²ä¸Šå‚³çš„é¡Œç›®</h2>
        <div id="questionsList" class="question-list">ç­‰å¾…è¼‰å…¥...</div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api/admin';

        // ç¢ºä¿ DOM å®Œå…¨è¼‰å…¥
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        function initApp() {
            console.log('åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
            
            try {
                // å–å¾—æ‰€æœ‰ DOM å…ƒç´ ä¸¦æª¢æŸ¥
                const questionForm = document.getElementById('questionForm');
                const optionsContainer = document.getElementById('optionsContainer');
                const addOptionBtn = document.getElementById('addOptionBtn');
                const clearFormBtn = document.getElementById('clearFormBtn');
                const clearAllBtn = document.getElementById('clearAllBtn');
                const questionsListDiv = document.getElementById('questionsList');
                const statusDiv = document.getElementById('status');

                // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!questionForm) throw new Error('æ‰¾ä¸åˆ° questionForm');
                if (!optionsContainer) throw new Error('æ‰¾ä¸åˆ° optionsContainer');
                if (!addOptionBtn) throw new Error('æ‰¾ä¸åˆ° addOptionBtn');
                if (!clearFormBtn) throw new Error('æ‰¾ä¸åˆ° clearFormBtn');
                if (!clearAllBtn) throw new Error('æ‰¾ä¸åˆ° clearAllBtn');
                if (!questionsListDiv) throw new Error('æ‰¾ä¸åˆ° questionsListDiv');
                if (!statusDiv) throw new Error('æ‰¾ä¸åˆ° statusDiv');

                console.log('æ‰€æœ‰ DOM å…ƒç´ å·²æ‰¾åˆ°');

                // --- UI åŠŸèƒ½ ---
                const addOption = () => {
                    const optionCount = optionsContainer.children.length + 1;
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option-input';
                    optionDiv.innerHTML = `
                        <input type="text" placeholder="é¸é … ${optionCount}" class="option-input-field">
                        <button type="button" class="danger">ç§»é™¤</button>`;
                    const removeBtn = optionDiv.querySelector('button');
                    if (removeBtn) {
                        removeBtn.addEventListener('click', function() {
                            optionDiv.remove();
                        });
                    }
                    optionsContainer.appendChild(optionDiv);
                };

                const showStatus = (message, type = 'success') => {
                    statusDiv.className = `status ${type} show`;
                    statusDiv.textContent = message;
                    if (statusDiv.fadeTimeout) clearTimeout(statusDiv.fadeTimeout);
                    statusDiv.fadeTimeout = setTimeout(() => {
                        statusDiv.classList.remove('show');
                    }, 3000);
                };

                const clearForm = () => {
                    questionForm.reset();
                    optionsContainer.innerHTML = '';
                };

                const renderQuestions = (questions) => {
                    if (!questions || questions.length === 0) {
                        questionsListDiv.innerHTML = '<p>ç›®å‰æ²’æœ‰é¡Œç›®ã€‚</p>';
                        return;
                    }
                    questionsListDiv.innerHTML = '';
                    questions.forEach(q => {
                        const item = document.createElement('div');
                        item.className = 'question-item';
                        item.innerHTML = `
                            <div class="question-content">
                                <strong>(${q.q_code || q.id}) ${q.question}</strong>
                                <small>
                                    ç­”æ¡ˆ: ${q.correctanswer} | ç´¢å¼•: ${q.answer} | åˆ†é¡: ${q.category || 'ç„¡'} | è§£é‡‹: ${q.description || 'ç„¡'}
                                    ${q.options && q.options.length > 0 ? `| é¸é …: ${q.options.join(', ')}` : ''}
                                </small>
                            </div>
                            <div class="action-buttons">
                                <button type="button" class="danger" data-id="${q.id}">åˆªé™¤</button>
                            </div>`;
                        const deleteBtn = item.querySelector('.danger');
                        if (deleteBtn) {
                            deleteBtn.addEventListener('click', function() {
                                deleteQuestion(this.dataset.id);
                            });
                        }
                        questionsListDiv.appendChild(item);
                    });
                };

                // --- API ---
                const loadQuestions = async () => {
                    questionsListDiv.innerHTML = '<p>è¼‰å…¥ä¸­...</p>';
                    try {
                        const response = await fetch(`${API_BASE}/questions`);
                        const result = await response.json();
                        if (response.ok && result.success) {
                            renderQuestions(result.data);
                        } else {
                            showStatus(`è¼‰å…¥é¡Œç›®å¤±æ•—: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        showStatus(`ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
                        showDebug(`API éŒ¯èª¤: ${error.message}. è«‹ç¢ºèªå¾Œç«¯ä¼ºæœå™¨æ˜¯å¦åœ¨ ${API_BASE} é‹è¡Œ`);
                    }
                };

                const handleFormSubmit = async (e) => {
                    e.preventDefault();

                    const options = Array.from(document.querySelectorAll('.option-input-field'))
                        .map(input => input.value.trim())
                        .filter(value => value);

                    const answerIndex = parseInt(document.getElementById('correctAnswer').value);
                    const correctAnswerText = document.getElementById('correctAnswerText').value.trim();
                    const description = document.getElementById('description').value.trim();

                    const questionData = {
                        question: document.getElementById('questionText').value,
                        options: options,
                        answer: answerIndex, 
                        correctanswer: correctAnswerText, 
                        description: description, 
                        category: document.getElementById('category').value.trim() || null,
                        q_code: `${(document.getElementById('category').value || 'MISC').toUpperCase()}-${Date.now().toString().slice(-4)}${Math.floor(Math.random()*100)}`,
                        random: Math.random(),
                        uploadedBy: 'manual-input-v3'
                    };

                    try {
                        const response = await fetch(`${API_BASE}/questions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(questionData)
                        });
                        const result = await response.json();
                        if (response.ok && result.success) {
                            showStatus(`é¡Œç›®æ–°å¢æˆåŠŸï¼(Code: ${result.data.q_code})`, 'success');
                            clearForm();
                            loadQuestions();
                        } else {
                            showStatus(`éŒ¯èª¤: ${result.message || 'æ–°å¢å¤±æ•—'}`, 'error');
                        }
                    } catch (error) {
                        showStatus(`ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
                    }
                };

                const deleteQuestion = async (questionId) => {
                    if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¡Œç›® ID: ${questionId} å—ï¼Ÿ`)) return;
                    try {
                        const response = await fetch(`${API_BASE}/questions/${questionId}`, { method: 'DELETE' });
                        const result = await response.json();
                        if (response.ok && result.success) {
                            showStatus(`é¡Œç›® ${questionId} å·²åˆªé™¤`, 'success');
                            loadQuestions();
                        } else {
                            showStatus(`åˆªé™¤å¤±æ•—: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        showStatus(`ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
                    }
                };

                const clearAllQuestions = async () => {
                    if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é¡Œç›®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
                    try {
                        const response = await fetch(`${API_BASE}/questions`, { method: 'DELETE' });
                        const result = await response.json();
                        if (response.ok && result.success) {
                            showStatus('æ‰€æœ‰é¡Œç›®å·²æ¸…ç©º', 'success');
                            loadQuestions();
                        } else {
                            showStatus(`æ¸…ç©ºå¤±æ•—: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        showStatus(`ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
                    }
                };

                // ç¶å®šäº‹ä»¶
                questionForm.addEventListener('submit', handleFormSubmit);
                addOptionBtn.addEventListener('click', addOption);
                clearFormBtn.addEventListener('click', clearForm);
                clearAllBtn.addEventListener('click', clearAllQuestions);

                // åˆå§‹åŒ–
                addOption(); // é è¨­ä¸€å€‹é¸é …
                loadQuestions();

                console.log('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
                showDebug('åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        }
    </script>
</body>
</html>